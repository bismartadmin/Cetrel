--Impedir a liberação da requisição de compra com valor total maior ou igual a R$ 50.000,00 se a flag PATEC estiver desmarcada e os codigos de compra sejam iguais a RS.
DECLARE

rowkey_ varchar2(4000) := '&NEW:ROWKEY';
original_qty_ varchar2(4000) := '&NEW:ORIGINAL_QTY';
fbuy_unit_price_ varchar2(4000) := '&NEW:FBUY_UNIT_PRICE';
purchase_code_ varchar2(4000) := '&NEW:PURCHASE_CODE';
patec_ varchar2(4000) := NULL;
total_value_ varchar2(4000) := original_qty_*fbuy_unit_price_;

BEGIN
  
SELECT 'S'
INTO patec_
FROM PURCHASE_REQ_LINE_PART_CFT PRLP
WHERE PRLP.ROWKEY = rowkey_
AND PRLP.CF$_PATEC = 'SIM';
EXCEPTION WHEN NO_DATA_FOUND THEN patec_ := 'N';

  IF purchase_code_ IN ('RS','RPS','RSD','RSE','RSDC','RSFU')
    AND patec_ = 'N' 
    AND total_value_ >= 50000 THEN
    RAISE_APPLICATION_ERROR(-20100,'CTR_SUP_004: Em requisições de compra de serviço, a flag PATEC deverá ser marcada. Necessário incluir anexo PATEC.');
   END IF;
END;
