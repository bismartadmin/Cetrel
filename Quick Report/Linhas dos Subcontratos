select 
A.SUB_CON_NO SUBCONTRATO,
A.REV_SEQ REVISAO,
A.LINE_NO N_LINHA,
B.sub_con_desc DESCRICAO,
A.SUPPLIER_ID ID_FORNECEDOR,
B.SUB_CON_NAME NOME_CONTRATO,
IFSCTR.SUPPLIER_INFO_API.Get_Name(A.SUPPLIER_ID) NOME_FORNECEDOR,
B.state STATUS,
A.LINE_DESC DESC_LINHA,
TO_CHAR(IFSCTR.SUB_CON_ITEM_UTIL_API.Get_Total_Com_Value_Cc(A.SUB_CON_NO,A.REV_SEQ,A.LINE_NO), 'FM999G999G999D00', 'NLS_NUMERIC_CHARACTERS='',.''') VALOR_LINHA,
B.company EMPRESA,
A.CONTRACT SITE,
B.planned_start_date DATA_INICIAL_PLANEJADA,
B.planned_finish_date DATA_FINAL_PLANEJADA,
B.actual_start_date DATA_INICIAL_REAL,
B.actual_finish_date DATA_FINAL_REAL,
A.OPERATION_ID ID_OPERACAO,
A.PROJECT_ID ID_PROJETO,
A.SUB_PROJECT_ID ID_SUB_PROJETO,
B.id_index_readjustment INDICE_REAJUSTE,
A.PART_NO COD_MATERIAL,
IFSCTR.Purchase_Part_API.Get_Description(contract, part_no) DESC_MATERIAL,
IFSCTR.PURCHASE_ORDER_LINE_PART_API.Get_Buy_Qty_Due(B.CF$_N_ORDEM,A.line_no,1) QUANTIDADE,
A.ACTIVITY_SEQ SEQUENCIAL_ATIVIDADE,
A.PURCH_GROUP GRUPO_COMPRA,
B.c_manager_group_id ID_GERENTE,
B.CF$_DATA_REAJUSTE DATA_REAJUSTE,
(select Y.MAIOR_DATA from ifsinfo.bs_f_maior_data_subcon Y where y.SUB_CON_NO = a.SUB_CON_NO) DATA_ASSINATURA_QUALISIGN,
B.CF$_APROV_QUALISIGN APROV_QUALISIGN,
B.CF$_DATA_CANCELAMENTO DATA_CANCELAMENTO,
B.CF$_DATA_CONFIRMACAO_ORDEM DATA_CONFIRMACAO_ORDEM,
TO_CHAR(B.CF$_SALDO_CONTRATO, 'FM999G999G999D00', 'NLS_NUMERIC_CHARACTERS='',.''') SALDO_CONTRATO,
B.CF$_N_REQUISICAO N_REQUISICAO,
B.CF$_N_ORDEM N_ORDEM,
B.PAY_TERM_ID COND_PAGTO,
B.CF$_DATA_CRIACAO_SUBCON DATA_CRIACAO_SUBCON,
(SELECT e.code_b FROM IFSCTR.PURCHASE_ORDER_LINE_PART E WHERE E.line_no = A.line_no AND E.order_no = B.CF$_N_ORDEM FETCH FIRST ROW ONLY) C_CUSTO,
B.main_sub_con_no N_CONTRATO_GLOBAL,
IFSCTR.PURCHASE_ORDER_API.Get_Buyer_Code(B.CF$_N_ORDEM) COMPRADOR,
SUCR.C_REVISION_VALUE VALOR_TOTAL,
IFSCTR.SUBVAL_VALUATION_LINE_API.GET_LINE_TOTAL_CERTIFIED(A.SUB_CON_NO, 1, A.LINE_NO) VALOR_CERTIFICADO,
A.CF$_VALOR_SALDO VALOR_SALDO_LINHA,
CASE WHEN B.CF$_ESCOPO LIKE '%ADITIVO%' OR B.CF$_ESCOPO LIKE '%Aditivo%' OR B.CF$_ESCOPO LIKE '%aditivo%' OR B.CF$_ESCOPO LIKE '%aditivado%' OR B.CF$_ESCOPO LIKE '%Aditivado%' OR B.CF$_ESCOPO LIKE '%ADITIVADO%' THEN 'SIM' ELSE 'NAO' END ADITIVO,
B.CF$_ESCOPO ESCOPO,
--CASE WHEN (B.planned_finish_date-sysdate) <0 THEN 'Vencido' ELSE TO_CHAR(ROUND((B.planned_finish_date-sysdate), 2))  END DIAS_VENCIMENTO,
(TRUNC(B.planned_finish_date) - TRUNC(SYSDATE)) + 1 AS DIAS_VENCIMENTO,
(SELECT K.INQUIRY_NO FROM IFSCTR.QUOTATION_LINE_PART_ORD_CON K WHERE K.ORDER_NO = B.CF$_N_ORDEM FETCH FIRST ROW ONLY) N_SOLICITACAO,
A.CF$_DEPARTAMENTO DEPARTAMENTO,
(SELECT LISTAGG(codeno_b, ', ') WITHIN GROUP (ORDER BY pre_accounting_id) FROM ifsctr.pre_accounting
WHERE parent_pre_accounting_id = (select t.pre_accounting_id from ifsctr.purchase_req_line_part t where b.CF$_N_REQUISICAO = t.REQUISITION_NO fetch first row only)
GROUP BY parent_pre_accounting_id) C_CUSTO_DISTRIBUICAO,
PURCH_REQ_LINE_APPROVAL_API.GET_DATE_APPROVED(A.CF$_N_REQUISICAO,A.LINE_NO,1,1) DATA_AUTORIZ_REQ_DEPTO,
PURCH_REQ_LINE_APPROVAL_API.GET_DATE_APPROVED(A.CF$_N_REQUISICAO,A.LINE_NO,1,2) DATA_AUTORIZ_REQ_COMPRADORES,
PURCHASE_REQ_LINE_PART_API.GET_C_STATE_SERV_PROV(A.CF$_N_REQUISICAO,A.line_no,1) ESTADO,
(SELECT F.city_name FROM IFSCTR.CITY_CODE F WHERE F.CITY_CODE = PURCHASE_REQ_LINE_PART_API.Get_C_City_Serv_Prov(A.CF$_N_REQUISICAO,A.line_no,1)) CIDADE
FROM IFSCTR.SUB_CON_LINE_CFV A
    ,IFSCTR.SUB_CONTRACT_CFV B
    ,SUB_CON_REVISION SUCR
WHERE A.SUB_CON_NO = B.SUB_CON_NO
AND   A.SUB_CON_NO = SUCR.SUB_CON_NO
AND   A.REV_SEQ    = SUCR.REV_SEQ
AND  (A.SUB_CON_NO LIKE '%' || '&SUBCONTRATO' || '%')
AND   (UPPER(PURCHASE_BUYER_API.Get_Name(PURCHASE_ORDER_API.Get_Buyer_Code(SUB_CONTRACT_CFP.Get_Cf$_N_Ordem(A.sub_con_no)))) LIKE '%' || UPPER('&COMPRADOR') || '%')
AND  (A.SUPPLIER_ID LIKE '%' || '&ID_FORNECEDOR' || '%')
AND  (A.CONTRACT LIKE '%' || '&SITE' || '%')
AND   B.CF$_DATA_CRIACAO_SUBCON BETWEEN NVL(TO_DATE('&CRIADO_DE','DD/MM/YYYY'),TO_DATE('01/01/2021','DD/MM/YYYY')) 
              AND NVL(TO_DATE('&CRIADO_ATE','DD/MM/YYYY'), TO_DATE('31/12/2099', 'DD/MM/YYYY'))
AND   A.REV_SEQ = (SELECT MAX(C.REV_SEQ)
                   FROM IFSCTR.SUB_CON_REVISION C
                   WHERE C.SUB_CON_NO = A.SUB_CON_NO
                   AND   C.STATE <> 'Cancelled')
