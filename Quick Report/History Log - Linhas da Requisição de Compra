select SUBSTR(A.KEYS, INSTR(A.KEYS, 'REQUISITION_NO=') + LENGTH('REQUISITION_NO='), INSTR(A.KEYS, '^', INSTR(A.KEYS, 'REQUISITION_NO=')) - (INSTR(A.KEYS, 'REQUISITION_NO=') + LENGTH('REQUISITION_NO='))) AS N_REQUISITION,
SUBSTR(A.KEYS, INSTR(A.KEYS, 'LINE_NO=') + LENGTH('LINE_NO='), INSTR(A.KEYS, '^', INSTR(A.KEYS, 'LINE_NO=')) - (INSTR(A.KEYS, 'LINE_NO=') + LENGTH('LINE_NO='))) AS N_LINHA,
  A.TIME_STAMP DATA_HORA,
  CASE WHEN A.HISTORY_TYPE_DB = '1' THEN 'Inserir'
       WHEN A.HISTORY_TYPE_DB = '2' THEN 'Alterar' ELSE 'Excluir' END TIPO_HISTORICO,
  A.USERNAME USUARIO,
  CASE WHEN B.COLUMN_NAME = 'BUYER_CODE' THEN 'Comprador'
       WHEN B.COLUMN_NAME = 'C_CITY_SERV_PROV' THEN 'Cidade Prestação de Serviço'
       WHEN B.COLUMN_NAME = 'C_COUNTRY_SERV_PROV' THEN 'País Prestação de Serviço'
       WHEN B.COLUMN_NAME = 'C_END_VALIDITY_DATE' THEN 'Data Final Vigência'
       WHEN B.COLUMN_NAME = 'C_INITIAL_VALIDITY_DATE' THEN 'Data Inicial Vigência'
       WHEN B.COLUMN_NAME = 'C_STATE_SERV_PROV' THEN 'Estado Prestação de Serviço'
       WHEN B.COLUMN_NAME = 'CONTRACT' THEN 'Site'
       WHEN B.COLUMN_NAME = 'LINE_NO' THEN 'Linha'
       WHEN B.COLUMN_NAME = 'DISCOUNT' THEN 'Desconto'
       WHEN B.COLUMN_NAME = 'FBUY_UNIT_PRICE' THEN 'Preço/Moeda'
       WHEN B.COLUMN_NAME = 'ORDER_CODE' THEN 'Cód Ordem'
       WHEN B.COLUMN_NAME = 'ORIGINAL_QTY' THEN 'Quantidade'
       WHEN B.COLUMN_NAME = 'PART_NO' THEN 'Cód Mat'
       WHEN B.COLUMN_NAME = 'PURCHASE_CODE' THEN 'Código de Compra'
       WHEN B.COLUMN_NAME = 'ROWSTATE' THEN 'Status'
       WHEN B.COLUMN_NAME = 'VENDOR_NO' THEN 'Fornecedor'
       WHEN B.COLUMN_NAME = 'WANTED_RECEIPT_DATE' THEN 'Data Recebimento Desejada'
       WHEN B.COLUMN_NAME = 'CF$_DESCR_LOCAL_EXECUCAO' THEN 'Desc Local Execução'
       WHEN B.COLUMN_NAME = 'CF$_ESCOPO' THEN 'Escopo'
       WHEN B.COLUMN_NAME = 'CF$_JUSTIFICATIVA' THEN 'Justificativa'
       WHEN B.COLUMN_NAME = 'CF$_LOCAL_DE_EXECUCAO' THEN 'Local de Execução'
       WHEN B.COLUMN_NAME = 'CF$_MOTIVO' THEN 'Motivo'
       WHEN B.COLUMN_NAME = 'CF$_PATEC' THEN 'Patec'
         ELSE B.COLUMN_NAME END COLUNA,
  CASE WHEN B.COLUMN_NAME = 'FBUY_UNIT_PRICE' THEN NVL(TO_CHAR(B.OLD_VALUE, 'FM999G999G999D00', 'NLS_NUMERIC_CHARACTERS='',.'''),0)
       WHEN B.COLUMN_NAME = 'C_INITIAL_VALIDITY_DATE' THEN TO_CHAR(TO_DATE(B.OLD_VALUE, 'YYYYMMDD HH24:MI:SS'), 'DD/MM/YYYY HH24:MI:SS')
       WHEN B.COLUMN_NAME = 'C_END_VALIDITY_DATE' THEN TO_CHAR(TO_DATE(B.OLD_VALUE, 'YYYYMMDD HH24:MI:SS'), 'DD/MM/YYYY HH24:MI:SS')
       WHEN B.COLUMN_NAME = 'C_CITY_SERV_PROV' THEN (SELECT Y.CITY_NAME FROM CITY_CODE Y WHERE Y.CITY_CODE = B.OLD_VALUE) ELSE  B.OLD_VALUE END VALOR_ANTERIOR,
  CASE WHEN B.COLUMN_NAME = 'FBUY_UNIT_PRICE' THEN NVL(TO_CHAR(B.NEW_VALUE, 'FM999G999G999D00', 'NLS_NUMERIC_CHARACTERS='',.'''),0)
       WHEN B.COLUMN_NAME = 'C_END_VALIDITY_DATE' THEN TO_CHAR(TO_DATE(B.NEW_VALUE, 'YYYYMMDD HH24:MI:SS'), 'DD/MM/YYYY HH24:MI:SS')
       WHEN B.COLUMN_NAME = 'C_INITIAL_VALIDITY_DATE' THEN TO_CHAR(TO_DATE(B.NEW_VALUE, 'YYYYMMDD HH24:MI:SS'), 'DD/MM/YYYY HH24:MI:SS')
       WHEN B.COLUMN_NAME = 'C_CITY_SERV_PROV' THEN (SELECT Y.CITY_NAME FROM IFSCTR.CITY_CODE Y WHERE Y.CITY_CODE = B.NEW_VALUE) ELSE  B.NEW_VALUE END VALOR_ATUAL
  from ifsinfo.BS_F_HISTORY_LOG A
  join ifsctr.history_log_attribute B  on a.log_id = b.log_id
  where a.history_type_db IN ('2','3')
  and a.table_name IN ('PURCHASE_REQ_LINE_TAB','PURCHASE_REQ_LINE_PART_CFT')
  and b.column_name <> 'ROWSTATE'
and b.column_name <> 'REQUISITION_NO'
  and
  (  SUBSTR(A.KEYS, INSTR(A.KEYS, 'REQUISITION_NO=') + LENGTH('REQUISITION_NO='), INSTR(A.KEYS, '^', INSTR(A.KEYS, 'REQUISITION_NO=')) - (INSTR(A.KEYS, 'REQUISITION_NO=') + LENGTH('REQUISITION_NO=')))
  = COALESCE ('&N_REQUISICAO',
  SUBSTR(A.KEYS, INSTR(A.KEYS, 'REQUISITION_NO=') + LENGTH('REQUISITION_NO='), INSTR(A.KEYS, '^', INSTR(A.KEYS, 'REQUISITION_NO=')) - (INSTR(A.KEYS, 'REQUISITION_NO=') + LENGTH('REQUISITION_NO=')))  ))
  ORDER BY TIME_STAMP DESC
