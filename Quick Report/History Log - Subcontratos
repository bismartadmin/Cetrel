select HL.TIME_STAMP DATA,
SUBSTR(HL.KEYS, INSTR(HL.KEYS, 'SUB_CON_NO=') + LENGTH('SUB_CON_NO='), INSTR(HL.KEYS, '^', INSTR(HL.KEYS, 'SUB_CON_NO=')) - (INSTR(HL.KEYS, 'SUB_CON_NO=') + LENGTH('SUB_CON_NO='))) N_SUBCONTRATO,
USERNAME USUARIO,
CASE WHEN HISTORY_TYPE_DB = '1' THEN 'Criação'
     WHEN HISTORY_TYPE_DB = '2' THEN 'Alteração'
     ELSE 'Exclusão'
END TIPO_HISTORICO,
CASE WHEN COLUMN_NAME = 'ROWSTATE' THEN 'Status'
     WHEN COLUMN_NAME = 'C_MANAGER_GROUP_ID' THEN 'ID Grupo Gerente'
     WHEN COLUMN_NAME = 'COMPANY' THEN 'Empresa'
     WHEN COLUMN_NAME = 'SITE' THEN 'Site'
     WHEN COLUMN_NAME = 'PLANNED_FINISH_DATE' THEN 'Data Final Planejado'
     WHEN COLUMN_NAME = 'PLANNED_START_DATE' THEN 'Data Inicio Planejado'
     WHEN COLUMN_NAME = 'SUPPLIER_ID' THEN 'Fornecedor'
     WHEN COLUMN_NAME = 'PAY_TERM_ID' THEN 'Cond Pagto'
     WHEN COLUMN_NAME = 'BUYER_CODE' THEN 'Comprador'
     WHEN COLUMN_NAME = 'PROJECT_ID' THEN 'Projeto'
     WHEN COLUMN_NAME = 'IO_RULE_ID' THEN 'ID Regra'
     WHEN COLUMN_NAME = 'CF$_DATA_REAJUSTE' THEN 'Data Reajuste'
     WHEN COLUMN_NAME = 'PART_NO' THEN 'Código Material'
     ELSE COLUMN_NAME
END COLUNA,
OLD_VALUE VALOR_ANTERIOR,
NEW_VALUE NOVO_VALOR
from IFSINFO.BS_F_HISTORY_LOG HL
left join IFSCTR.HISTORY_LOG_ATTRIBUTE HLA ON HLA.log_id = HL.LOG_ID
where table_name IN ('SUB_CONTRACT_TAB','SUB_CONTRACT_CFT','SUB_CON_PROJECT_TAB','SUB_CON_LINE_TAB')
and NEW_VALUE <> '<UNDEFINED>'
and (SUBSTR(HL.KEYS, INSTR(HL.KEYS, 'SUB_CON_NO=') + LENGTH('SUB_CON_NO='), INSTR(HL.KEYS, '^', INSTR(HL.KEYS, 'SUB_CON_NO=')) - (INSTR(HL.KEYS, 'SUB_CON_NO=') + LENGTH('SUB_CON_NO='))) LIKE '%' || '&N_SUBCON')
